# Ikabud Kernel - Instance .htaccess Template
# This file is copied to new instances and works in shared hosting

# Enable rewrite engine
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>

# Force correct MIME types for static assets
# Works in shared hosting without VirtualHost access
<IfModule mod_mime.c>
    # CSS
    AddType text/css .css
    
    # JavaScript
    AddType application/javascript .js
    AddType application/javascript .mjs
    
    # Fonts
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType font/ttf .ttf
    AddType font/otf .otf
    AddType application/vnd.ms-fontobject .eot
    
    # Images
    AddType image/svg+xml .svg
    AddType image/webp .webp
    
    # Other
    AddType application/json .json
    AddType application/xml .xml
</IfModule>

# Security headers (shared hosting compatible)
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Clickjacking protection
    Header set X-Frame-Options "SAMEORIGIN"
    
    # XSS protection
    Header set X-XSS-Protection "1; mode=block"
    
    # CORS headers for cross-subdomain requests (works for any .test domain)
    # This handles OPTIONS preflight requests at Apache level
    # Matches any subdomain of any .test domain (e.g., admin.thejake.test, dashboard.magic.test)
    SetEnvIf Origin "^https?://(.+\.)?([^.]+\.test)$" ORIGIN_ALLOWED=$0
    Header always set Access-Control-Allow-Origin "%{ORIGIN_ALLOWED}e" env=ORIGIN_ALLOWED
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" env=ORIGIN_ALLOWED
    Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, X-WP-Nonce, Content-Type, Accept, Authorization, X-HTTP-Method-Override" env=ORIGIN_ALLOWED
    Header always set Access-Control-Allow-Credentials "true" env=ORIGIN_ALLOWED
    
    # Handle OPTIONS preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# CMS-specific rewrite rules will be added here by InstanceBootstrapper
# WordPress, Joomla, Drupal each have their own rules

##
# Joomla SEF URL Rewrite Rules
##
<IfModule mod_rewrite.c>
RewriteEngine On

# Redirect to https (optional, comment out if not using SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Block access to specific directories
RewriteRule ^administrator/components/com_joomlaupdate/restore\.php$ - [L]
RewriteRule ^administrator/components/com_admintools/restore\.php$ - [L]
RewriteRule ^(\.git|cache|includes|language|logs|log|tmp)/ - [F]

# Block access to configuration.php
RewriteRule ^configuration\.php - [F]

# Block access to htaccess.txt and web.config
RewriteRule ^(htaccess\.txt|web\.config)$ - [F]

# SEF URLs - Rewrite all requests to index.php unless they are actual files/directories
RewriteCond %{REQUEST_URI} \!^/index\.php
RewriteCond %{REQUEST_URI} (/|\.php|\.html|\.htm|\.feed|\.pdf|\.raw|/[^.]*)$  [NC]
RewriteCond %{REQUEST_FILENAME} \!-f
RewriteCond %{REQUEST_FILENAME} \!-d
RewriteRule .* index.php [L]
</IfModule>
