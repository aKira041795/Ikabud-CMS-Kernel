#!/usr/bin/env php
<?php declare(strict_types=1);
/**
 * Drupal Instance Creator (PHP CLI)
 * 
 * Creates a Drupal instance with symlinks to shared core
 * Compatible with shared hosting environments
 * 
 * Usage: ./create-drupal-instance <instance_id> <instance_name> <domain> <db_name> <db_user> <db_pass> [db_prefix]
 */

// Colors for output
define('GREEN', "\033[0;32m");
define('YELLOW', "\033[1;33m");
define('RED', "\033[0;31m");
define('NC', "\033[0m"); // No Color

if ($argc < 7) {
    echo RED . "Usage: $argv[0] <instance_id> <instance_name> <domain> <db_name> <db_user> <db_pass> [db_prefix] [drupal_version]" . NC . "\n";
    echo "Example: $argv[0] dpl-shop-001 'My Drupal Shop' shop.example.com ikabud_drupal root password drupal_\n";
    echo "         $argv[0] dpl-shop-002 'My Drupal 11 Shop' shop2.example.com ikabud_drupal root password drupal_ drupal11\n";
    exit(1);
}

$instanceId = $argv[1];
$instanceName = $argv[2];
$domain = $argv[3];
$dbName = $argv[4];
$dbUser = $argv[5];
$dbPass = $argv[6];
$dbPrefix = $argv[7] ?? '';
$drupalVersion = $argv[8] ?? 'drupal'; // Default to drupal (v9.5.11)

$rootPath = dirname(__DIR__);
$instancePath = "$rootPath/instances/$instanceId";
$sharedCore = "$rootPath/shared-cores/$drupalVersion";
$hashSalt = bin2hex(random_bytes(32));

echo YELLOW . "Creating Drupal instance: $instanceId" . NC . "\n";
echo "Instance Name: $instanceName\n";
echo "Domain: $domain\n";
echo "Database: $dbName\n";
echo "Drupal Version: $drupalVersion\n\n";

// Validate instance doesn't exist
if (is_dir($instancePath)) {
    echo RED . "Error: Instance directory already exists: $instancePath" . NC . "\n";
    exit(1);
}

// Validate shared core exists
if (!is_dir($sharedCore)) {
    echo RED . "Error: Shared Drupal core not found: $sharedCore" . NC . "\n";
    exit(1);
}

// Step 1: Create instance directory structure
echo YELLOW . "[1/9]" . NC . " Creating instance directory structure...\n";
$directories = [
    '',
    '/sites',
    '/sites/default',
    '/sites/default/files',
    '/sites/default/files/translations',
    '/sites/default/private',
];

foreach ($directories as $dir) {
    @mkdir($instancePath . $dir, 0775, true);
}

// Set ownership to www-data for the entire instance directory
exec("chown -R www-data:www-data " . escapeshellarg($instancePath) . " 2>&1", $chownOutput, $chownReturn);

echo GREEN . "✓" . NC . " Directory structure created\n";

// Step 2: Create symlinks to shared core (excluding 'core' directory)
echo YELLOW . "[2/9]" . NC . " Creating symlinks to shared Drupal core...\n";

// Symlink core directories and files (excluding 'core' and 'index.php')
$coreSymlinks = [
    'autoload.php',
    'composer.json',
    'composer.lock',
    'modules',
    'profiles',
    'robots.txt',
    'themes',
    'update.php',
    'vendor',
    '.htaccess',
    '.csslintrc',
    '.editorconfig',
    '.eslintignore',
    '.eslintrc.json',
];

foreach ($coreSymlinks as $item) {
    $relativeTarget = "../../shared-cores/$drupalVersion/$item";
    @symlink($relativeTarget, "$instancePath/$item");
}

// Create real 'core' directory with wrapper install.php
mkdir("$instancePath/core", 0775);

// Create wrapper install.php that sets correct root before loading shared core installer
$coreInstallContent = <<<COREINSTALL
<?php
/**
 * Drupal installer wrapper for Ikabud Kernel instance
 * Sets the correct application root before loading the shared core installer
 */

// The shared core installer does chdir('..') to go from /core to root
// So we need to be IN the /core directory when we call it
// That way chdir('..') brings us to the instance root

// We're already in /core, so the shared installer's chdir('..') will work correctly
// It will change to the instance root (parent of this /core directory)

// Now include the actual Drupal installer from shared core
// It will do chdir('..') which takes us from /core to instance root
require_once __DIR__ . '/../../../shared-cores/$drupalVersion/core/install.php';

COREINSTALL;

file_put_contents("$instancePath/core/install.php", $coreInstallContent);
chmod("$instancePath/core/install.php", 0644);

// Symlink all contents of shared core's /core directory (except install.php which we created above)
$sharedCoreDir = "$sharedCore/core";
$coreItems = scandir($sharedCoreDir);
foreach ($coreItems as $item) {
    if ($item === '.' || $item === '..' || $item === 'install.php') {
        continue;
    }
    $target = "../../../shared-cores/$drupalVersion/core/$item";
    @symlink($target, "$instancePath/core/$item");
}

// Create custom index.php that sets the correct document root
$indexContent = <<<'INDEX'
<?php

/**
 * @file
 * The PHP page that serves all page requests on a Drupal installation.
 * 
 * Custom index.php for Ikabud Kernel instance
 * This ensures Drupal uses the instance's sites directory, not the shared core's
 */

use Drupal\Core\DrupalKernel;
use Symfony\Component\HttpFoundation\Request;

// Set the application root to this instance directory
$app_root = __DIR__;
chdir($app_root);

$autoloader = require_once 'autoload.php';

// Pass the app_root to DrupalKernel so it uses this instance's sites directory
$kernel = new DrupalKernel('prod', $autoloader, FALSE, $app_root);

$request = Request::createFromGlobals();
$response = $kernel->handle($request);

// Check if running through Ikabud Kernel
if (defined('IKABUD_DRUPAL_KERNEL')) {
    // Don't send response yet - let kernel cache it
    // Store response in global for kernel to access
    $GLOBALS['ikabud_drupal_response'] = $response;
} else {
    // Direct access - send response normally
    $response->send();
}

$kernel->terminate($request, $response);

INDEX;

file_put_contents("$instancePath/index.php", $indexContent);
chmod("$instancePath/index.php", 0644);

// Create sites/sites.php for multi-site configuration
$sitesPhpContent = <<<SITESPHP
<?php

/**
 * @file
 * Site directory mapping for Ikabud Kernel Drupal instance
 */

// Map all domains to use this instance's sites/default directory
\$sites = [
  'admin.$domain' => 'default',
  '$domain' => 'default',
];

SITESPHP;

file_put_contents("$instancePath/sites/sites.php", $sitesPhpContent);
chmod("$instancePath/sites/sites.php", 0644);

echo GREEN . "✓" . NC . " Symlinks, custom index.php, core wrapper, and sites.php created\n";

// Step 3: Create or verify database
echo YELLOW . "[3/9]" . NC . " Setting up database...\n";
try {
    // Try to connect to the database first (shared hosting scenario)
    try {
        $testPdo = new PDO("mysql:host=localhost;dbname=$dbName", $dbUser, $dbPass);
        echo GREEN . "✓" . NC . " Database already exists: $dbName (using existing)\n";
    } catch (PDOException $e) {
        // Database doesn't exist, try to create it
        $pdo = new PDO("mysql:host=localhost", $dbUser, $dbPass);
        $pdo->exec("CREATE DATABASE `$dbName` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci");
        echo GREEN . "✓" . NC . " Database created: $dbName\n";
    }
} catch (PDOException $e) {
    echo RED . "✗" . NC . " Database setup failed: " . $e->getMessage() . "\n";
    echo YELLOW . "  Please create the database manually and ensure credentials are correct\n";
    exit(1);
}

// Step 4: Create settings.php
echo YELLOW . "[4/9]" . NC . " Creating settings.php...\n";

$settingsContent = <<<SETTINGS
<?php

/**
 * Drupal Configuration
 * Ikabud Kernel Instance: $instanceId
 * Generated: {date('D M j H:i:s T Y')}
 */

// Database settings
\$databases['default']['default'] = [
  'database' => '$dbName',
  'username' => '$dbUser',
  'password' => '$dbPass',
  'host' => 'localhost',
  'port' => '3306',
  'driver' => 'mysql',
  'prefix' => '',
  'collation' => 'utf8mb4_general_ci',
];

// Salt for one-time login links, cancel links, form tokens, etc.
\$settings['hash_salt'] = '$hashSalt';

// Location of the site configuration files
\$settings['config_sync_directory'] = '$instancePath/sites/default/files/config/sync';

// Private file path
\$settings['file_private_path'] = '$instancePath/sites/default/private';

// Temporary directory
\$settings['file_temp_path'] = '/tmp';

// Trusted host patterns
\$settings['trusted_host_patterns'] = [
  '^' . preg_quote('$domain') . '\$',
  '^admin\\.' . preg_quote('$domain') . '\$',
  '^backend\\.' . preg_quote('$domain') . '\$',
];

// Reverse proxy configuration (for Ikabud Kernel)
\$settings['reverse_proxy'] = FALSE;

// File system settings
\$settings['file_public_path'] = 'sites/default/files';
\$settings['file_public_base_url'] = '';

// Update free access (set to FALSE after installation)
\$settings['update_free_access'] = FALSE;

// Skip file system permissions hardening
\$settings['skip_permissions_hardening'] = TRUE;

// Ikabud Kernel Integration
\$settings['ikabud_instance_id'] = '$instanceId';
\$settings['ikabud_kernel_path'] = dirname(dirname(__DIR__)) . '/kernel';

// Base URL (dynamic based on current host)
\$base_url = 'http://' . (\$_SERVER['HTTP_HOST'] ?? '$domain');

// Development settings (disable in production)
// \$config['system.logging']['error_level'] = 'verbose';
// \$config['system.performance']['css']['preprocess'] = FALSE;
// \$config['system.performance']['js']['preprocess'] = FALSE;

SETTINGS;

file_put_contents("$instancePath/sites/default/settings.php", $settingsContent);
chmod("$instancePath/sites/default/settings.php", 0644);
echo GREEN . "✓" . NC . " settings.php created\n";

// Step 5: Create services.yml and symlink default.settings.php
echo YELLOW . "[5/9]" . NC . " Creating services.yml and default.settings.php...\n";
copy("$sharedCore/sites/default/default.services.yml", "$instancePath/sites/default/services.yml");
chmod("$instancePath/sites/default/services.yml", 0644);

// Symlink default.settings.php from shared core (required by Drupal installer)
// Path from sites/default/ needs to go up 4 levels: default -> sites -> instance -> instances -> kernel root
@symlink("../../../../shared-cores/drupal/sites/default/default.settings.php", "$instancePath/sites/default/default.settings.php");

echo GREEN . "✓" . NC . " services.yml and default.settings.php created\n";

// Step 6: Create instance manifest
echo YELLOW . "[6/9]" . NC . " Creating instance manifest...\n";
$manifest = [
    'instance_id' => $instanceId,
    'instance_name' => $instanceName,
    'cms_type' => 'drupal',
    'domain' => $domain,
    'admin_subdomain' => "admin.$domain",
    'database' => [
        'name' => $dbName,
        'user' => $dbUser,
        'host' => 'localhost',
        'prefix' => $dbPrefix,
    ],
    'created_at' => date('c'),
    'version' => '1.0',
];
file_put_contents("$instancePath/instance.json", json_encode($manifest, JSON_PRETTY_PRINT));
echo GREEN . "✓" . NC . " Instance manifest created\n";

// Step 7: Set permissions
echo YELLOW . "[7/9]" . NC . " Setting permissions...\n";

// Set directory permissions (777 for files directory to ensure web server can write)
chmod("$instancePath/sites/default", 0775);
chmod("$instancePath/sites/default/files", 0777);
chmod("$instancePath/sites/default/private", 0777);

// Create subdirectories with proper permissions
@mkdir("$instancePath/sites/default/files/translations", 0777, true);
@mkdir("$instancePath/sites/default/files/config", 0777, true);
@mkdir("$instancePath/sites/default/files/config/sync", 0777, true);

// Set file permissions (writable for installer)
chmod("$instancePath/sites/default/settings.php", 0666);
chmod("$instancePath/sites/default/services.yml", 0666);

// Try to change ownership to www-data if sudo is available (optional)
exec("sudo chown -R www-data:www-data '$instancePath/sites/default/files' 2>&1", $output, $returnCode);
if ($returnCode === 0) {
    exec("sudo chown www-data:www-data '$instancePath/sites/default/settings.php' 2>&1");
    exec("sudo chown www-data:www-data '$instancePath/sites/default/services.yml' 2>&1");
    echo GREEN . "✓" . NC . " Permissions and ownership set\n";
} else {
    echo GREEN . "✓" . NC . " Permissions set (directories are world-writable for Drush)\n";
}

// Step 8: Register instance in database
echo YELLOW . "[8/9]" . NC . " Registering instance in database...\n";
try {
    $pdo = new PDO("mysql:host=localhost;dbname=$dbName", $dbUser, $dbPass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // Register in instances table
    $stmt = $pdo->prepare("
        INSERT INTO `ikabud-kernel`.instances 
        (instance_id, instance_name, cms_type, domain, path_prefix, database_name, database_prefix, status, config, resources, created_at, updated_at)
        VALUES (?, ?, 'drupal', ?, '/', ?, ?, 'active', '[]', '{\"cpu_limit\": 1, \"memory_limit\": 256}', NOW(), NOW())
    ");
    $stmt->execute([$instanceId, $instanceName, $domain, $dbName, $dbPrefix]);
    
    echo GREEN . "✓" . NC . " Instance registered in database\n";
    
    // Register as process
    if (file_exists("$rootPath/bin/register-instance-process")) {
        passthru("$rootPath/bin/register-instance-process '$instanceId' '$instanceName' 'drupal'");
    }
} catch (PDOException $e) {
    echo YELLOW . "⚠" . NC . " Database registration failed: " . $e->getMessage() . "\n";
}

// Step 9: Install Drupal using Drush
echo YELLOW . "[9/9]" . NC . " Installing Drupal via Drush...\n";
$drushPath = "$sharedCore/vendor/bin/drush.php";

if (file_exists($drushPath)) {
    // Check if drush is executable
    if (!is_executable($drushPath)) {
        chmod($drushPath, 0755);
        echo "   Made Drush executable\n";
    }
    
    // Detect PHP CLI path with multiple fallbacks
    $phpPath = PHP_BINARY; // Start with current PHP binary
    
    // Try to find PHP in common locations if PHP_BINARY seems wrong
    if (!file_exists($phpPath) || !is_executable($phpPath)) {
        $possiblePaths = [
            '/usr/bin/php',
            '/usr/local/bin/php',
            '/opt/php/bin/php',
            trim(shell_exec('which php 2>/dev/null') ?: ''),
        ];
        
        foreach ($possiblePaths as $path) {
            if ($path && file_exists($path) && is_executable($path)) {
                $phpPath = $path;
                break;
            }
        }
    }
    
    echo "   Using PHP: $phpPath\n";
    echo "   Using Drush: $drushPath\n";
    echo "   Instance Path: $instancePath\n";
    
    // Verify PHP is executable
    if (!file_exists($phpPath) || !is_executable($phpPath)) {
        echo RED . "✗" . NC . " PHP executable not found or not executable: $phpPath\n";
        echo YELLOW . "   Complete installation manually at: http://admin.$domain/core/install.php" . NC . "\n";
    } else {
        // Make shared core's sites/default writable for Drush
        // This gets overwritten each time but instances use their own settings.php
        @chmod("$sharedCore/sites/default", 0777);
        @chmod("$sharedCore/sites/default/files", 0777);
        if (file_exists("$sharedCore/sites/default/settings.php")) {
            @chmod("$sharedCore/sites/default/settings.php", 0666);
        }
        
        // Change to instance directory (required for Drush to work correctly)
        $originalDir = getcwd();
        chdir($instancePath);
        
        // Set up environment variables for Drush
        putenv("DRUSH_PHP=$phpPath");
        // Set HOME directory for Drush (required for Symfony filesystem)
        $homeDir = getenv('HOME') ?: '/tmp';
        putenv("HOME=$homeDir");
        // Force Drush to use instance's sites directory
        putenv("DRUPAL_SITES_DIRECTORY=$instancePath/sites");
        
        $dbUrl = "mysql://$dbUser:$dbPass@localhost/$dbName";
        
        // Build Drush command arguments with explicit paths
        $drushArgs = [
            escapeshellarg($phpPath),
            escapeshellarg($drushPath),
            'site:install',
            'standard',
            '--root=' . escapeshellarg($instancePath),
            '--sites-subdir=default',
            '--uri=' . escapeshellarg("http://$domain"),
            '--db-url=' . escapeshellarg($dbUrl),
            '--site-name=' . escapeshellarg($instanceName),
            '--account-name=admin',
            '--account-pass=admin123',
            '--account-mail=' . escapeshellarg("admin@$domain"),
            '--yes',
            '2>&1'
        ];
        
        $installCmd = implode(' ', $drushArgs);
        
        echo "   Installing Drupal (this may take 2-3 minutes)...\n";
        echo "   Running: drush site:install standard...\n\n";
        
        // Use passthru for real-time output visibility
        passthru($installCmd, $installReturn);
        
        // Change back to original directory
        chdir($originalDir);
        
        echo "\n";
        if ($installReturn === 0) {
            echo GREEN . "✓" . NC . " Drupal installed successfully via Drush\n";
            
            // Install cache invalidation module
            echo YELLOW . "   Installing Ikabud cache invalidation module..." . NC . "\n";
            
            // Create module directory
            $moduleDir = "$instancePath/modules/custom/ikabud_cache";
            @mkdir($moduleDir, 0755, true);
            
            // Copy module file from template
            $templatePath = "$rootPath/templates/ikabud-cache-invalidation-drupal.php";
            if (file_exists($templatePath)) {
                copy($templatePath, "$moduleDir/ikabud_cache.module");
                
                // Create module info file
                $infoContent = <<<INFO
name: 'Ikabud Cache Invalidation'
type: module
description: 'Automatically invalidates Ikabud Kernel cache when content changes'
core_version_requirement: ^10 || ^11
package: 'Ikabud'
INFO;
                file_put_contents("$moduleDir/ikabud_cache.info.yml", $infoContent);
                
                // Enable the module via Drush
                chdir($instancePath);
                $enableCmd = escapeshellarg($phpPath) . ' ' . escapeshellarg($drushPath) . ' pm:enable ikabud_cache -y 2>&1';
                $enableOutput = shell_exec($enableCmd);
                chdir($originalDir);
                
                echo GREEN . "   ✓ Cache invalidation module installed and enabled\n" . NC;
            } else {
                echo YELLOW . "   ⚠ Cache invalidation template not found, skipping\n" . NC;
            }
            
            // Clean up shared core settings.php created by Drush
            echo YELLOW . "   Cleaning up shared core settings.php..." . NC . "\n";
            if (file_exists("$sharedCore/sites/default/settings.php")) {
                @unlink("$sharedCore/sites/default/settings.php");
                echo GREEN . "   ✓ Shared core settings.php removed\n" . NC;
            }
        } else {
            echo RED . "✗" . NC . " Drupal installation failed (exit code: $installReturn)\n";
            echo YELLOW . "   Complete installation manually at: http://admin.$domain/core/install.php" . NC . "\n";
        }
    }
} else {
    echo YELLOW . "⚠" . NC . " Drush not found at: $drushPath\n";
    echo YELLOW . "   Install Drupal manually at: http://admin.$domain/core/install.php" . NC . "\n";
}

// Summary
echo "\n";
echo GREEN . "=========================================" . NC . "\n";
echo GREEN . "Drupal Instance Created Successfully!" . NC . "\n";
echo GREEN . "=========================================" . NC . "\n";
echo "\n";
echo "Instance ID: " . YELLOW . $instanceId . NC . "\n";
echo "Domain: " . YELLOW . $domain . NC . "\n";
echo "Admin URL: " . YELLOW . "admin.$domain" . NC . "\n";
echo "Database: " . YELLOW . $dbName . NC . "\n";
echo "\n";
echo YELLOW . "Access Information:" . NC . "\n";
echo "Frontend URL: " . GREEN . "http://$domain" . NC . "\n";
echo "Admin URL:    " . GREEN . "http://admin.$domain" . NC . "\n";
echo "Username:     " . GREEN . "admin" . NC . "\n";
echo "Password:     " . GREEN . "admin123" . NC . "\n";
echo "\n";
echo "=========================================" . NC . "\n";
