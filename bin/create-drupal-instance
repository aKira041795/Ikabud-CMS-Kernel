#!/usr/bin/env php
<?php
/**
 * Drupal Instance Creator (PHP CLI)
 * 
 * Creates a Drupal instance with symlinks to shared core
 * Compatible with shared hosting environments
 * 
 * Usage: ./create-drupal-instance <instance_id> <instance_name> <domain> <db_name> <db_user> <db_pass> [db_prefix]
 */

declare(strict_types=1);

// Colors for output
define('GREEN', "\033[0;32m");
define('YELLOW', "\033[1;33m");
define('RED', "\033[0;31m");
define('NC', "\033[0m"); // No Color

if ($argc < 7) {
    echo RED . "Usage: $argv[0] <instance_id> <instance_name> <domain> <db_name> <db_user> <db_pass> [db_prefix]" . NC . "\n";
    echo "Example: $argv[0] dpl-shop-001 'My Drupal Shop' shop.example.com ikabud_drupal root password drupal_\n";
    exit(1);
}

$instanceId = $argv[1];
$instanceName = $argv[2];
$domain = $argv[3];
$dbName = $argv[4];
$dbUser = $argv[5];
$dbPass = $argv[6];
$dbPrefix = $argv[7] ?? '';

$rootPath = dirname(__DIR__);
$instancePath = "$rootPath/instances/$instanceId";
$sharedCore = "$rootPath/shared-cores/drupal";
$hashSalt = bin2hex(random_bytes(32));

echo YELLOW . "Creating Drupal instance: $instanceId" . NC . "\n";
echo "Instance Name: $instanceName\n";
echo "Domain: $domain\n";
echo "Database: $dbName\n\n";

// Validate instance doesn't exist
if (is_dir($instancePath)) {
    echo RED . "Error: Instance directory already exists: $instancePath" . NC . "\n";
    exit(1);
}

// Validate shared core exists
if (!is_dir($sharedCore)) {
    echo RED . "Error: Shared Drupal core not found: $sharedCore" . NC . "\n";
    exit(1);
}

// Step 1: Create instance directory structure
echo YELLOW . "[1/8]" . NC . " Creating instance directory structure...\n";
$directories = [
    '',
    '/sites/default',
    '/sites/default/files',
    '/sites/default/files/translations',
    '/sites/default/private',
];

foreach ($directories as $dir) {
    @mkdir($instancePath . $dir, 0755, true);
}
echo GREEN . "✓" . NC . " Directory structure created\n";

// Step 2: Create symlinks to shared core
echo YELLOW . "[2/8]" . NC . " Creating symlinks to shared Drupal core...\n";

// Symlink core directories and files
$coreSymlinks = [
    'autoload.php',
    'composer.json',
    'composer.lock',
    'core',
    'index.php',
    'modules',
    'profiles',
    'robots.txt',
    'themes',
    'update.php',
    'vendor',
    '.htaccess',
    '.csslintrc',
    '.editorconfig',
    '.eslintignore',
    '.eslintrc.json',
];

foreach ($coreSymlinks as $item) {
    @symlink("../../$sharedCore/$item", "$instancePath/$item");
}

echo GREEN . "✓" . NC . " Symlinks created\n";

// Step 3: Create database
echo YELLOW . "[3/8]" . NC . " Creating database...\n";
try {
    $pdo = new PDO("mysql:host=localhost", $dbUser, $dbPass);
    $pdo->exec("CREATE DATABASE IF NOT EXISTS `$dbName` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci");
    echo GREEN . "✓" . NC . " Database created: $dbName\n";
} catch (PDOException $e) {
    echo YELLOW . "⚠" . NC . " Database creation failed or already exists\n";
}

// Step 4: Create settings.php
echo YELLOW . "[4/8]" . NC . " Creating settings.php...\n";

$settingsContent = <<<SETTINGS
<?php

/**
 * Drupal Configuration
 * Ikabud Kernel Instance: $instanceId
 * Generated: {date('D M j H:i:s T Y')}
 */

// Database settings
\$databases['default']['default'] = [
  'database' => '$dbName',
  'username' => '$dbUser',
  'password' => '$dbPass',
  'host' => 'localhost',
  'port' => '3306',
  'driver' => 'mysql',
  'prefix' => '$dbPrefix',
  'collation' => 'utf8mb4_general_ci',
];

// Salt for one-time login links, cancel links, form tokens, etc.
\$settings['hash_salt'] = '$hashSalt';

// Location of the site configuration files
\$settings['config_sync_directory'] = '$instancePath/sites/default/files/config/sync';

// Private file path
\$settings['file_private_path'] = '$instancePath/sites/default/private';

// Temporary directory
\$settings['file_temp_path'] = '/tmp';

// Trusted host patterns
\$settings['trusted_host_patterns'] = [
  '^' . preg_quote('$domain') . '\$',
  '^admin\\.' . preg_quote('$domain') . '\$',
  '^backend\\.' . preg_quote('$domain') . '\$',
];

// Reverse proxy configuration (for Ikabud Kernel)
\$settings['reverse_proxy'] = FALSE;

// File system settings
\$settings['file_public_path'] = 'sites/default/files';
\$settings['file_public_base_url'] = '';

// Update free access (set to FALSE after installation)
\$settings['update_free_access'] = FALSE;

// Skip file system permissions hardening
\$settings['skip_permissions_hardening'] = TRUE;

// Ikabud Kernel Integration
\$settings['ikabud_instance_id'] = '$instanceId';
\$settings['ikabud_kernel_path'] = dirname(dirname(__DIR__)) . '/kernel';

// Base URL (dynamic based on current host)
\$base_url = 'http://' . (\$_SERVER['HTTP_HOST'] ?? '$domain');

// Development settings (disable in production)
// \$config['system.logging']['error_level'] = 'verbose';
// \$config['system.performance']['css']['preprocess'] = FALSE;
// \$config['system.performance']['js']['preprocess'] = FALSE;

SETTINGS;

file_put_contents("$instancePath/sites/default/settings.php", $settingsContent);
chmod("$instancePath/sites/default/settings.php", 0644);
echo GREEN . "✓" . NC . " settings.php created\n";

// Step 5: Create services.yml
echo YELLOW . "[5/8]" . NC . " Creating services.yml...\n";
copy("$sharedCore/sites/default/default.services.yml", "$instancePath/sites/default/services.yml");
chmod("$instancePath/sites/default/services.yml", 0644);
echo GREEN . "✓" . NC . " services.yml created\n";

// Step 6: Create instance manifest
echo YELLOW . "[6/8]" . NC . " Creating instance manifest...\n";
$manifest = [
    'instance_id' => $instanceId,
    'instance_name' => $instanceName,
    'cms_type' => 'drupal',
    'domain' => $domain,
    'admin_subdomain' => "admin.$domain",
    'database' => [
        'name' => $dbName,
        'user' => $dbUser,
        'host' => 'localhost',
        'prefix' => $dbPrefix,
    ],
    'created_at' => date('c'),
    'version' => '1.0',
];
file_put_contents("$instancePath/instance.json", json_encode($manifest, JSON_PRETTY_PRINT));
echo GREEN . "✓" . NC . " Instance manifest created\n";

// Step 7: Set permissions
echo YELLOW . "[7/8]" . NC . " Setting permissions...\n";
chmod("$instancePath/sites/default", 0755);
chmod("$instancePath/sites/default/files", 0775);
chmod("$instancePath/sites/default/private", 0775);
echo GREEN . "✓" . NC . " Permissions set\n";

// Step 8: Register as process
echo YELLOW . "[8/8]" . NC . " Registering instance as process...\n";
if (file_exists("$rootPath/bin/register-instance-process")) {
    passthru("$rootPath/bin/register-instance-process '$instanceId' '$instanceName' 'drupal'");
} else {
    echo YELLOW . "⚠" . NC . " Process registration script not found (skipping)\n";
}

// Summary
echo "\n";
echo GREEN . "=========================================" . NC . "\n";
echo GREEN . "Drupal Instance Created Successfully!" . NC . "\n";
echo GREEN . "=========================================" . NC . "\n";
echo "\n";
echo "Instance ID: " . YELLOW . $instanceId . NC . "\n";
echo "Domain: " . YELLOW . $domain . NC . "\n";
echo "Admin URL: " . YELLOW . "admin.$domain" . NC . "\n";
echo "Database: " . YELLOW . $dbName . NC . "\n";
echo "\n";
echo YELLOW . "Next Steps:" . NC . "\n";
echo "1. Configure virtual hosts for $domain\n";
echo "2. Install Drupal:\n";
echo "   " . GREEN . "http://admin.$domain/core/install.php" . NC . "\n";
echo "\n";
echo "=========================================" . NC . "\n";
