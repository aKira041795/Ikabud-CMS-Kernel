#!/usr/bin/env php
<?php
/**
 * WordPress Instance Creator (PHP CLI)
 * 
 * Creates a WordPress instance with symlinks to shared core
 * Compatible with shared hosting environments
 * 
 * Usage: ./create-wordpress-instance <instance_id> <instance_name> <db_name> <domain> [cms_type] [db_user] [db_pass] [db_host] [db_prefix]
 */

declare(strict_types=1);

// Colors for output
define('GREEN', "\033[0;32m");
define('YELLOW', "\033[1;33m");
define('RED', "\033[0;31m");
define('NC', "\033[0m"); // No Color

if ($argc < 5) {
    echo RED . "Usage: $argv[0] <instance_id> <instance_name> <database_name> <domain> [cms_type] [db_user] [db_pass] [db_host] [db_prefix]" . NC . "\n";
    echo "Example: $argv[0] wp-shop-001 'My Shop' ikabud_shop shop.example.com wordpress root password localhost wp_\n";
    exit(1);
}

$instanceId = $argv[1];
$instanceName = $argv[2];
$dbName = $argv[3];
$domain = $argv[4];
$cmsType = $argv[5] ?? 'wordpress';
$dbUser = $argv[6] ?? getenv('DB_USER') ?: 'root';
$dbPass = $argv[7] ?? getenv('DB_PASSWORD') ?: '';
$dbHost = $argv[8] ?? 'localhost';
$dbPrefix = $argv[9] ?? 'wp_';

$rootPath = dirname(__DIR__);
$instancePath = "$rootPath/instances/$instanceId";
$sharedCore = "$rootPath/shared-cores/wordpress";

echo "=========================================\n";
echo "Ikabud Kernel - WordPress Instance Creator\n";
echo "Symlink Approach (Shared Core)\n";
echo "=========================================\n\n";
echo "Instance ID:   $instanceId\n";
echo "Instance Name: $instanceName\n";
echo "CMS Type:      $cmsType\n";
echo "Database:      $dbName\n";
echo "Domain:        $domain\n";
echo "DB Host:       $dbHost\n";
echo "DB Prefix:     $dbPrefix\n\n";

// Check if instance already exists
if (is_dir($instancePath)) {
    echo RED . "✗ Instance already exists: $instancePath" . NC . "\n";
    exit(1);
}

// Check if shared core exists
if (!is_dir($sharedCore)) {
    echo RED . "✗ Shared WordPress core not found: $sharedCore" . NC . "\n";
    exit(1);
}

// Step 1: Create instance directory structure
echo YELLOW . "[1/6]" . NC . " Creating instance directory structure...\n";
mkdir($instancePath, 0755, true);
mkdir("$instancePath/wp-content", 0755, true);
mkdir("$instancePath/wp-content/plugins", 0755, true);
mkdir("$instancePath/wp-content/themes", 0755, true);
mkdir("$instancePath/wp-content/uploads", 0755, true);
mkdir("$instancePath/wp-content/mu-plugins", 0755, true);
echo GREEN . "✓" . NC . " Directory structure created\n";

// Step 2: Create symlinks to shared core
echo YELLOW . "[2/6]" . NC . " Creating symlinks to shared WordPress core...\n";
$symlinkMap = [
    'wp-admin' => '../../shared-cores/wordpress/wp-admin',
    'wp-includes' => '../../shared-cores/wordpress/wp-includes',
    'index.php' => '../../shared-cores/wordpress/index.php',
    'wp-activate.php' => '../../shared-cores/wordpress/wp-activate.php',
    'wp-blog-header.php' => '../../shared-cores/wordpress/wp-blog-header.php',
    'wp-comments-post.php' => '../../shared-cores/wordpress/wp-comments-post.php',
    'wp-cron.php' => '../../shared-cores/wordpress/wp-cron.php',
    'wp-links-opml.php' => '../../shared-cores/wordpress/wp-links-opml.php',
    'wp-load.php' => '../../shared-cores/wordpress/wp-load.php',
    'wp-login.php' => '../../shared-cores/wordpress/wp-login.php',
    'wp-mail.php' => '../../shared-cores/wordpress/wp-mail.php',
    'wp-settings.php' => '../../shared-cores/wordpress/wp-settings.php',
    'wp-signup.php' => '../../shared-cores/wordpress/wp-signup.php',
    'wp-trackback.php' => '../../shared-cores/wordpress/wp-trackback.php',
    'xmlrpc.php' => '../../shared-cores/wordpress/xmlrpc.php',
];

foreach ($symlinkMap as $link => $target) {
    symlink($target, "$instancePath/$link");
}
echo GREEN . "✓" . NC . " Symlinks created\n";

// Step 3: Generate wp-config.php
echo YELLOW . "[3/6]" . NC . " Generating wp-config.php...\n";

// Generate security keys (WordPress-style random strings)
function generateWPKey($length = 64) {
    $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_[]{}<>~`+=,.;:/?|';
    $key = '';
    $charsLength = strlen($chars);
    for ($i = 0; $i < $length; $i++) {
        $key .= $chars[random_int(0, $charsLength - 1)];
    }
    return $key;
}

$keys = [
    'AUTH_KEY' => generateWPKey(),
    'SECURE_AUTH_KEY' => generateWPKey(),
    'LOGGED_IN_KEY' => generateWPKey(),
    'NONCE_KEY' => generateWPKey(),
    'AUTH_SALT' => generateWPKey(),
    'SECURE_AUTH_SALT' => generateWPKey(),
    'LOGGED_IN_SALT' => generateWPKey(),
    'NONCE_SALT' => generateWPKey(),
];

$generatedDate = date('D M j H:i:s T Y');

$wpConfig = <<<CONFIG
<?php
/**
 * WordPress Configuration
 * Ikabud Kernel Instance: $instanceId
 * Generated: $generatedDate
 */

// Database Configuration
define('DB_NAME', '$dbName');
define('DB_USER', '$dbUser');
define('DB_PASSWORD', '$dbPass');
define('DB_HOST', '$dbHost');
define('DB_CHARSET', 'utf8mb4');
define('DB_COLLATE', '');

// Authentication Keys and Salts
define('AUTH_KEY',         '{$keys['AUTH_KEY']}');
define('SECURE_AUTH_KEY',  '{$keys['SECURE_AUTH_KEY']}');
define('LOGGED_IN_KEY',    '{$keys['LOGGED_IN_KEY']}');
define('NONCE_KEY',        '{$keys['NONCE_KEY']}');
define('AUTH_SALT',        '{$keys['AUTH_SALT']}');
define('SECURE_AUTH_SALT', '{$keys['SECURE_AUTH_SALT']}');
define('LOGGED_IN_SALT',   '{$keys['LOGGED_IN_SALT']}');
define('NONCE_SALT',       '{$keys['NONCE_SALT']}');

// WordPress Database Table prefix
\$table_prefix = '$dbPrefix';

// WordPress Debugging
define('WP_DEBUG', false);
define('WP_DEBUG_LOG', false);
define('WP_DEBUG_DISPLAY', false);

// Force direct filesystem method (no FTP needed)
define('FS_METHOD', 'direct');

// ** CRITICAL: WordPress URLs **
// Dynamic URLs based on current host to prevent redirects
\$current_host = \$_SERVER['HTTP_HOST'] ?? '$domain';

// Determine if this is a backend/admin subdomain
\$is_backend = (
    strpos(\$current_host, 'backend.') === 0 || 
    strpos(\$current_host, 'admin.') === 0 || 
    strpos(\$current_host, 'dashboard.') === 0
);

// Check if WordPress is installed and get URLs from database
\$wp_installed = false;
\$db_siteurl = null;
\$db_home = null;

try {
    \$check_pdo = new PDO("mysql:host=$dbHost;dbname=$dbName", '$dbUser', '$dbPass');
    \$check_result = \$check_pdo->query("SHOW TABLES LIKE '{$dbPrefix}options'");
    \$wp_installed = (\$check_result && \$check_result->rowCount() > 0);
    
    // If installed, get URLs from database
    if (\$wp_installed) {
        \$url_query = \$check_pdo->query("SELECT option_name, option_value FROM {$dbPrefix}options WHERE option_name IN ('siteurl', 'home')");
        while (\$row = \$url_query->fetch(PDO::FETCH_ASSOC)) {
            if (\$row['option_name'] === 'siteurl') {
                \$db_siteurl = \$row['option_value'];
            } elseif (\$row['option_name'] === 'home') {
                \$db_home = \$row['option_value'];
            }
        }
    }
} catch (Exception \$e) {
    \$wp_installed = false;
}

// If accessing frontend and WP not installed, redirect to backend installation
if (!\$is_backend && !\$wp_installed && !defined('WP_INSTALLING')) {
    \$backend_domain = 'admin.' . \$current_host;
    header('Location: http://' . \$backend_domain . '/wp-admin/install.php');
    exit;
}

// Set WP_SITEURL and WP_HOME
if (\$db_siteurl && \$db_home) {
    // WordPress is installed - use URLs from database
    define('WP_SITEURL', \$db_siteurl);
    define('WP_HOME', \$db_home);
} else {
    // WordPress not installed yet - use dynamic URLs for installation
    if (\$is_backend) {
        // Backend subdomain - WordPress admin/API access
        \$frontend_domain = preg_replace('/^(backend|admin|dashboard)\./', '', \$current_host);
        define('WP_SITEURL', 'http://' . \$current_host);
        define('WP_HOME', 'http://' . \$frontend_domain);
    } else {
        // Frontend domain - public site access
        define('WP_SITEURL', 'http://admin.' . \$current_host);
        define('WP_HOME', 'http://' . \$current_host);
    }
}

// ** CRITICAL: Cookie Configuration **
// Ensure cookies work correctly when served through Kernel
// Extract base domain for cookie sharing across subdomains
// Works with patterns like: admin.domain.com, backend.domain.com, domain.com
\$host_parts = explode('.', \$current_host);
if (count(\$host_parts) >= 2) {
    // Get last two parts (domain.tld) for cookie domain
    \$base_domain = '.' . implode('.', array_slice(\$host_parts, -2));
} else {
    \$base_domain = \$current_host;
}

define('COOKIE_DOMAIN', \$base_domain);
define('COOKIEPATH', '/');
define('SITECOOKIEPATH', '/');
define('ADMIN_COOKIE_PATH', '/');

// ** CRITICAL: Instance-specific wp-content paths **
// This ensures themes, plugins, and uploads are stored in the instance folder
define('WP_CONTENT_DIR', __DIR__ . '/wp-content');
// Use current host for wp-content URL to avoid cross-domain issues
define('WP_CONTENT_URL', 'http://' . \$current_host . '/wp-content');

// Ikabud Kernel Integration
define('IKABUD_INSTANCE_ID', '$instanceId');
define('IKABUD_KERNEL_PATH', dirname(dirname(__DIR__)) . '/kernel');

// Absolute path to WordPress directory (shared core)
if (!defined('ABSPATH')) {
    define('ABSPATH', dirname(dirname(__DIR__)) . '/shared-cores/wordpress/');
}

// Sets up WordPress vars and included files
require_once ABSPATH . 'wp-settings.php';

CONFIG;

file_put_contents("$instancePath/wp-config.php", $wpConfig);
chmod("$instancePath/wp-config.php", 0644);
echo GREEN . "✓" . NC . " wp-config.php created\n";

// Step 4: Copy .htaccess and MU plugins
echo YELLOW . "[4/6]" . NC . " Setting up CORS and cache configuration...\n";

// Copy .htaccess template
$htaccessTemplate = "$rootPath/templates/instance.htaccess";
if (file_exists($htaccessTemplate)) {
    copy($htaccessTemplate, "$instancePath/.htaccess");
    echo GREEN . "✓" . NC . " Copied .htaccess with CORS configuration\n";
} else {
    echo YELLOW . "⚠" . NC . " .htaccess template not found (skipping)\n";
}

// Copy CORS plugin to mu-plugins
$corsPlugin = "$rootPath/templates/ikabud-cors.php";
if (file_exists($corsPlugin)) {
    copy($corsPlugin, "$instancePath/wp-content/mu-plugins/ikabud-cors.php");
    echo GREEN . "✓" . NC . " Installed CORS handler plugin (mu-plugins)\n";
} else {
    echo YELLOW . "⚠" . NC . " CORS plugin template not found (skipping)\n";
}

// Copy cache invalidation plugin to mu-plugins
$cachePlugin = "$rootPath/templates/ikabud-cache-invalidation.php";
if (file_exists($cachePlugin)) {
    copy($cachePlugin, "$instancePath/wp-content/mu-plugins/ikabud-cache-invalidation.php");
    echo GREEN . "✓" . NC . " Installed cache invalidation plugin (mu-plugins)\n";
} else {
    echo YELLOW . "⚠" . NC . " Cache invalidation plugin template not found (skipping)\n";
}

// Copy DiSyL integration plugin to mu-plugins
$disylPlugin = "$rootPath/templates/ikabud-disyl-integration.php";
if (file_exists($disylPlugin)) {
    copy($disylPlugin, "$instancePath/wp-content/mu-plugins/ikabud-disyl-integration.php");
    echo GREEN . "✓" . NC . " Installed DiSyL integration plugin (mu-plugins)\n";
} else {
    echo YELLOW . "⚠" . NC . " DiSyL integration plugin template not found (skipping)\n";
}

// Step 5: Create instance manifest
echo YELLOW . "[5/6]" . NC . " Creating instance manifest...\n";
$manifest = [
    'instance_id' => $instanceId,
    'instance_name' => $instanceName,
    'cms_type' => $cmsType,
    'domain' => $domain,
    'admin_subdomain' => "admin.$domain",
    'database' => [
        'name' => $dbName,
        'user' => $dbUser,
        'host' => $dbHost,
        'prefix' => $dbPrefix,
    ],
    'created_at' => date('c'),
    'version' => '1.0',
];

file_put_contents("$instancePath/instance.json", json_encode($manifest, JSON_PRETTY_PRINT));
echo GREEN . "✓" . NC . " Instance manifest created\n";

// Step 6: Create database
echo YELLOW . "[6/7]" . NC . " Creating database...\n";
try {
    $pdo = new PDO("mysql:host=$dbHost", $dbUser, $dbPass);
    $pdo->exec("CREATE DATABASE IF NOT EXISTS `$dbName` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
    echo GREEN . "✓" . NC . " Database created: $dbName\n";
} catch (PDOException $e) {
    echo YELLOW . "⚠" . NC . " Database creation failed or already exists: " . $e->getMessage() . "\n";
}

// Step 7: Register as process
echo YELLOW . "[7/7]" . NC . " Registering instance as process...\n";
if (file_exists("$rootPath/bin/register-instance-process")) {
    passthru("$rootPath/bin/register-instance-process '$instanceId' '$instanceName' '$cmsType'");
} else {
    echo YELLOW . "⚠" . NC . " Process registration script not found (skipping)\n";
}

// Summary
echo "\n";
echo GREEN . "=========================================" . NC . "\n";
echo GREEN . "WordPress Instance Created Successfully!" . NC . "\n";
echo GREEN . "=========================================" . NC . "\n";
echo "\n";
echo "Instance ID:   " . YELLOW . $instanceId . NC . "\n";
echo "Instance Name: " . YELLOW . $instanceName . NC . "\n";
echo "Domain:        " . YELLOW . $domain . NC . "\n";
echo "Database:      " . YELLOW . $dbName . NC . "\n";
echo "\n";
echo YELLOW . "Next Steps:" . NC . "\n";
echo "1. Configure virtual hosts for $domain\n";
echo "2. Install WordPress:\n";
echo "   " . GREEN . "http://admin.$domain/wp-admin/install.php" . NC . "\n";
echo "\n";
echo "=========================================\n";
