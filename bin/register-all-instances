#!/usr/bin/env php
<?php
/**
 * Register All Instances as Processes
 * 
 * Creates process entries for all active instances in the database
 */

declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use IkabudKernel\Core\Kernel;
use IkabudKernel\Core\Config;

// Initialize Config
Config::getInstance();

try {
    Kernel::boot();
    $kernel = Kernel::getInstance();
    $db = $kernel->getDatabase();
    
    echo "Registering all active instances as processes...\n\n";
    
    // Get all active instances
    $stmt = $db->query("
        SELECT instance_id, instance_name, cms_type 
        FROM instances 
        WHERE status = 'active'
        ORDER BY instance_id
    ");
    
    $instances = $stmt->fetchAll(PDO::FETCH_ASSOC);
    $registered = 0;
    $skipped = 0;
    
    foreach ($instances as $instance) {
        $instanceId = $instance['instance_id'];
        $instanceName = $instance['instance_name'];
        $cmsType = $instance['cms_type'];
        
        // Check if process already exists
        $checkStmt = $db->prepare("
            SELECT COUNT(*) FROM kernel_processes 
            WHERE instance_id = ? AND process_type = 'cms'
        ");
        $checkStmt->execute([$instanceId]);
        
        if ($checkStmt->fetchColumn() > 0) {
            echo "â­  Skipped: {$instanceId} (already registered)\n";
            $skipped++;
            continue;
        }
        
        // Get next PID
        $pidStmt = $db->query("SELECT COALESCE(MAX(pid), 0) + 1 as next_pid FROM kernel_processes");
        $nextPid = $pidStmt->fetch(PDO::FETCH_ASSOC)['next_pid'];
        
        // Register as process (boot_time is boot duration in ms, not timestamp)
        $bootTime = 0.0; // Instant boot for pre-registered processes
        
        $insertStmt = $db->prepare("
            INSERT INTO kernel_processes 
            (pid, instance_id, process_name, process_type, cms_type, status, memory_usage, cpu_time, boot_time, started_at)
            VALUES (?, ?, ?, 'cms', ?, 'running', 0, 0, ?, NOW())
        ");
        
        $insertStmt->execute([
            $nextPid,
            $instanceId,
            $instanceName ?: $instanceId,
            $cmsType,
            $bootTime
        ]);
        
        echo "âœ“ Registered: {$instanceId} (PID: {$nextPid}, CMS: {$cmsType})\n";
        $registered++;
    }
    
    echo "\n";
    echo "========================================\n";
    echo "Summary:\n";
    echo "  Total instances: " . count($instances) . "\n";
    echo "  Registered: {$registered}\n";
    echo "  Skipped: {$skipped}\n";
    echo "========================================\n";
    
} catch (Exception $e) {
    echo "Error: " . $e->getMessage() . "\n";
    exit(1);
}
