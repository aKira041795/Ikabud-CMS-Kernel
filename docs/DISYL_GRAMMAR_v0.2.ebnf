(*
 * DiSyL Grammar Specification v0.2
 * Extended Backus-Naur Form (EBNF)
 * 
 * Notation:
 * - ::= defines a production rule
 * - | separates alternatives
 * - () groups items
 * - [] optional items (0 or 1)
 * - {} repetition (0 or more)
 * - "" literal strings
 * - (* *) comments
 * - [#xHHHH] Unicode code point ranges
 *)

(* ============================================================================
   DOCUMENT STRUCTURE
   ============================================================================ *)

document ::= { node }

node ::= tag_node
       | text_node
       | expression_node
       | comment_node

(* ============================================================================
   TAG NODES (Components)
   ============================================================================ *)

tag_node ::= self_closing_tag
           | paired_tag

self_closing_tag ::= "{" tag_name [ attributes ] "/" "}"

paired_tag ::= opening_tag { node } closing_tag

opening_tag ::= "{" tag_name [ attributes ] "}"

closing_tag ::= "{" "/" tag_name "}"

tag_name ::= component_name
           | control_structure_name

component_name ::= "ikb_" identifier

control_structure_name ::= "if" | "for" | "include"

(* ============================================================================
   ATTRIBUTES
   ============================================================================ *)

attributes ::= attribute { whitespace attribute }

attribute ::= identifier "=" attribute_value

attribute_value ::= quoted_string
                  | expression_string
                  | boolean_literal
                  | number_literal

quoted_string ::= '"' { string_char } '"'
                | "'" { string_char } "'"

expression_string ::= "{" expression "}"

boolean_literal ::= "true" | "false"

number_literal ::= [ "-" ] digit { digit } [ "." digit { digit } ]

(* ============================================================================
   EXPRESSIONS
   ============================================================================ *)

expression_node ::= "{" expression "}"

(* Enhanced Expression Grammar with Filter Pipeline *)
expression ::= pipe_expression

pipe_expression ::= primary_expression { "|" filter_call }

primary_expression ::= simple_expression
                     | property_access
                     | method_call
                     | "(" expression ")"

simple_expression ::= identifier

property_access ::= identifier { "." identifier }

method_call ::= identifier "(" [ argument_list ] ")"

(* Filter Syntax *)
filter_call ::= filter_name [ filter_arguments ]

filter_name ::= identifier

filter_arguments ::= ":" argument { "," argument }

argument ::= named_argument | positional_argument

named_argument ::= identifier "=" argument_value

positional_argument ::= quoted_string | number_literal | boolean_literal

argument_list ::= expression { "," expression }

(* ============================================================================
   TEXT NODES
   ============================================================================ *)

text_node ::= text_content

text_content ::= { text_char | interpolated_expression | significant_whitespace }

interpolated_expression ::= "{" expression "}"

text_char ::= unicode_char - ( "{" | "}" )

(* ============================================================================
   COMMENT NODES
   ============================================================================ *)

comment_node ::= "{!--" comment_content "--}"

comment_content ::= { any_char - "--}" }

(* ============================================================================
   LEXICAL ELEMENTS
   ============================================================================ *)

identifier ::= letter { identifier_char }

identifier_char ::= letter | digit | "_"

letter ::= [a-zA-Z]

digit ::= [0-9]

string_char ::= unicode_char - ( '"' | "'" | "\\" )
              | escape_sequence

escape_sequence ::= "\\" ( "\\" | '"' | "'" | "n" | "r" | "t" | "{" | "}" 
                  | "u" hex_digit hex_digit hex_digit hex_digit )

hex_digit ::= [0-9a-fA-F]

(* Unicode Support *)
unicode_char ::= #x0009 | #x000A | #x000D | [#x0020-#xD7FF] | [#xE000-#xFFFD]

any_char ::= unicode_char

(* Whitespace Handling *)
whitespace ::= ( " " | "\t" | "\n" | "\r" )+

significant_whitespace ::= ( "\n" | "\r" | "\t" | " " )+

(* ============================================================================
   CONTROL STRUCTURE SPECIFICS
   ============================================================================ *)

(* If Statement *)
if_statement ::= "{" "if" if_condition "}" document 
                 [ "{" "else" "}" document ] 
                 "{" "/" "if" "}"

if_condition ::= "condition" "=" expression_string

(* For Loop *)
for_loop ::= "{" "for" for_spec "}" document "{" "/" "for" "}"

for_spec ::= "items" "=" expression_string "as" "=" quoted_string

(* Include Directive *)
include_directive ::= "{" "include" include_spec "/" "}"

include_spec ::= "template" "=" quoted_string

(* ============================================================================
   RESERVED KEYWORDS
   ============================================================================ *)

(* Control Structures *)
reserved_control ::= "if" | "for" | "include"

(* Boolean Literals *)
reserved_boolean ::= "true" | "false"

(* Component Prefix *)
reserved_prefix ::= "ikb_"

(* ============================================================================
   NAMING CONVENTIONS
   ============================================================================ *)

(*
 * Component Names:
 * - Must start with "ikb_"
 * - Followed by lowercase letters, numbers, or underscores
 * - Examples: ikb_section, ikb_text, ikb_card
 *
 * Control Structures:
 * - Lowercase keywords: if, for, include
 * - No prefix required
 *
 * Attributes:
 * - Lowercase letters, numbers, or underscores
 * - Examples: type, size, weight, bg
 *
 * Expressions:
 * - Variable names: lowercase or camelCase
 * - Property access: dot notation (item.title)
 * - Examples: title, item.content, post.author.name
 *)

(* ============================================================================
   SYNTAX RULES
   ============================================================================ *)

(*
 * Rule 1: Self-Closing Tags
 * - Void components MUST be self-closing
 * - Use "/" before closing brace
 * - Example: {ikb_image src="..." /}
 *
 * Rule 2: Paired Tags
 * - Opening and closing tag names MUST match exactly
 * - Closing tag uses "/" prefix
 * - Example: {ikb_text}content{/ikb_text}
 *
 * Rule 3: Nesting
 * - Tags must be properly nested (no overlapping)
 * - Closing tags must match in reverse order of opening
 *
 * Rule 4: Expressions
 * - Standalone expressions: {variable}
 * - In text: "Hello {name}!"
 * - In attributes: title="{item.title}"
 *
 * Rule 5: Comments
 * - Use {!-- comment --} syntax
 * - Cannot be nested
 * - Can span multiple lines
 *
 * Rule 6: Whitespace
 * - Whitespace is preserved in text nodes (significant_whitespace)
 * - Whitespace between attributes is ignored
 * - Whitespace between tags is insignificant
 * - Indentation is recommended for readability
 *
 * Rule 7: Filter Pipelines
 * - Use pipe operator | to chain filters
 * - Filters can have named or positional arguments
 * - Arguments separated by commas
 * - Example: {item.title | upper | truncate:length=50}
 *)

(* ============================================================================
   EXAMPLES
   ============================================================================ *)

(*
 * Example 1: Simple Component
 * {ikb_text size="lg" weight="bold"}
 *     Hello World!
 * {/ikb_text}
 *
 * Example 2: Self-Closing Component
 * {ikb_image src="photo.jpg" alt="Photo" /}
 *
 * Example 3: Expression Interpolation
 * {ikb_text}
 *     Published on {item.date} by {item.author}
 * {/ikb_text}
 *
 * Example 4: Attribute Expressions
 * {ikb_card title="{item.title}" image="{item.thumbnail}" /}
 *
 * Example 5: Conditional Rendering
 * {if condition="item.thumbnail"}
 *     {ikb_image src="{item.thumbnail}" /}
 * {/if}
 *
 * Example 6: Loops
 * {for items="posts" as="post"}
 *     {ikb_text}{post.title}{/ikb_text}
 * {/for}
 *
 * Example 7: Includes
 * {include template="components/header" /}
 *
 * Example 8: Nested Components
 * {ikb_section type="hero"}
 *     {ikb_container width="lg"}
 *         {ikb_text size="2xl"}Welcome{/ikb_text}
 *     {/ikb_container}
 * {/ikb_section}
 *
 * Example 9: Comments
 * {!-- This is a comment --}
 * {ikb_text}Visible content{/ikb_text}
 * {!-- 
 *     Multi-line comment
 *     Can span multiple lines
 * --}
 *
 * Example 10: Filter Pipelines
 * {ikb_text}{item.title | upper}{/ikb_text}
 * {ikb_text}{item.content | truncate:length=100,append="..."}{/ikb_text}
 * {ikb_text}{item.date | date:format="F j, Y" | esc_html}{/ikb_text}
 *
 * Example 11: Complex Filter Chains
 * {ikb_text}{item.description | strip_tags | truncate:50 | upper}{/ikb_text}
 * {ikb_link href="{item.url | esc_url}"}{item.title | esc_html}{/ikb_link}
 *)

(* ============================================================================
   ERROR PRODUCTIONS
   ============================================================================ *)

(*
 * Common Errors:
 *
 * 1. Missing closing tag
 *    {ikb_text}content
 *    Error: Expected {/ikb_text}
 *
 * 2. Mismatched closing tag
 *    {ikb_section}{/ikb_container}
 *    Error: Expected {/ikb_section}, got {/ikb_container}
 *
 * 3. Non-self-closing void component
 *    {ikb_image src="..."}
 *    Error: ikb_image must be self-closing, use /}
 *
 * 4. Invalid attribute syntax
 *    {ikb_text size=lg}
 *    Error: Attribute value must be quoted
 *
 * 5. Unclosed expression
 *    {item.title
 *    Error: Expected }
 *
 * 6. Invalid component name
 *    {myComponent}
 *    Error: Component names must start with ikb_
 *
 * 7. Reserved keyword as identifier
 *    {if}content{/if}
 *    Error: 'if' is a control structure, requires condition attribute
 *
 * 8. Invalid filter syntax
 *    {item.title | }
 *    Error: Expected filter name after pipe operator
 *
 * 9. Missing filter argument value
 *    {item.content | truncate:length=}
 *    Error: Expected value after =
 *
 * 10. Unclosed filter expression
 *    {item.title | upper
 *    Error: Expected }
 *)

(* ============================================================================
   VERSION HISTORY
   ============================================================================ *)

(*
 * v0.2 (November 2025) - PEER REVIEW REVISION
 * - Added filter pipeline syntax with pipe operator
 * - Formalized control structure attributes (if/for/include)
 * - Enhanced whitespace handling (significant vs insignificant)
 * - Added Unicode support with code point ranges
 * - Improved character class definitions
 * - Added named and positional filter arguments
 * - Enhanced escape sequences with Unicode escapes
 * - Added error productions for filter syntax
 *
 * v0.1 (November 2025)
 * - Initial grammar specification
 * - Basic components and control structures
 * - Expression interpolation
 * - Attribute evaluation
 * - Comments
 *)
